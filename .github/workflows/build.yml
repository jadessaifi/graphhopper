name: Build and Test

on:
  push:

jobs:
  # ---- 1) Build & tests unitaires sur JDK 24 ----
  ci:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java-version: [24]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ matrix.java-version }}
          cache: maven

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ matrix.java-version }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Cache node binary
        uses: actions/cache@v4
        with:
          path: web-bundle/node
          key: ${{ runner.os }}-nodebin-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-nodebin-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: web-bundle/node_modules
          key: ${{ runner.os }}-modules-${{ hashFiles('**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-modules-

      - name: Build + test (JDK ${{ matrix.java-version }})
        run: mvn -B clean test
        env:
          MAVEN_OPTS: "-Xmx1g -Duser.language=en"

  # ---- 2) PIT Mutation Testing dédié (JDK 21) ----
  mutation:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Temurin 21 (stable for PIT)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build sans tests (prépare le SUT)
        run: mvn -B -q -DskipTests install
        env:
          MAVEN_OPTS: "-Xmx1g -Duser.language=en"

      # ⚠️ Important : on passe les options JVM via -DjvmArgs (et non -DargLine)
      - name: Lancer PIT sur le module reader-gtfs
        id: pit_run
        run: |
          mvn -B -pl reader-gtfs org.pitest:pitest-maven:1.16.0:mutationCoverage \
            -Dplugins=junit5 \
            -DjvmArgs="--enable-native-access=ALL-UNNAMED --add-opens=java.base/java.lang=ALL-UNNAMED -Xmx2g -Xms512m -Duser.language=en" \
            -Dthreads=2 \
            -DtimeoutConst=8000 \
            -Dmutators=STRONGER \
            -DtargetClasses=com.graphhopper.gtfs.* \
            -DtargetTests=**.*Test,**.*Tests
        env:
          MAVEN_OPTS: "-Xmx1g -Duser.language=en"

      - name: Extraire le score de mutation
        id: score
        run: |
          # Chemin du module PIT
          REPORT_DIR="reader-gtfs/target/pit-reports"
          if [ -d "$REPORT_DIR" ]; then
            SUMMARY=$(ls -dt "$REPORT_DIR"/* | head -n1)/summary.xml
            if [ -f "$SUMMARY" ]; then
              SCORE=$(grep -oPm1 "(?<=<score>)[^<]+" "$SUMMARY" || echo 0)
            else
              SCORE=0
            fi
          else
            SCORE=0
          fi
          echo "score=$SCORE" >> "$GITHUB_OUTPUT"
          echo "Score de mutation détecté: $SCORE"

      - name: Comparer au score précédent (si présent)
        run: |
          PREV=0
          if [ -f mutation_score.txt ]; then
            PREV=$(cat mutation_score.txt)
          fi
          CUR=${{ steps.score.outputs.score }}
          echo "Score précédent : $PREV"
          echo "Score courant   : $CUR"
          if [ "$CUR" -lt "$PREV" ]; then
            echo "::error::Le score de mutation a diminué ($CUR < $PREV)."
            exit 1
          fi
          echo "$CUR" > mutation_score.txt

      - name: Uploader le rapport PIT
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-report-reader-gtfs
          path: reader-gtfs/target/pit-reports
          if-no-files-found: warn
          compression-level: 6

      - name: Sauvegarder le nouveau score (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-score
          path: mutation_score.txt
          if-no-files-found: warn

      - name: Rickroll on failure
        if: failure()
        uses: ./.github/rickroll