name: CI - Build, Test & PIT

on:
  push:
    branches: [ "**" ]
  pull_request:

jobs:
  build-test-pit:
    runs-on: ubuntu-latest

    env:
      MODULE: core
      JAVA_VERSION: 21
      PIT_TARGET_CLASSES: com.graphhopper.routing.util.*
      PIT_TARGET_TESTS: com.graphhopper.routing.util.*


      PIT_CACHE_DIR: .pit-cache
      PIT_SCORE_FILE: .pit-cache/mutation_score.txt
      PIT_CACHE_PREFIX: pit-score-

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Temurin JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache Maven repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-${{ runner.os }}-

      - name: Restore previous PIT score
        uses: actions/cache@v4
        with:
          path: ${{ env.PIT_CACHE_DIR }}
          key: ${{ env.PIT_CACHE_PREFIX }}${{ github.run_id }}
          restore-keys: |
            ${{ env.PIT_CACHE_PREFIX }}

      - name: Build + unit tests
        run: mvn -B -q -DskipITs=true clean test

      - name: Install (skip tests)
        run: mvn -B -q -DskipTests install

      - name: Run PIT (mutation testing)
        working-directory: ${{ env.MODULE }}
        shell: bash
        run: |
          set -euo pipefail
          mvn -q org.pitest:pitest-maven:mutationCoverage \
            -DtargetClasses="${{ env.PIT_TARGET_CLASSES }}" \
            -DtargetTests="${{ env.PIT_TARGET_TESTS }}" \
            | tee pit.log

      - name: Extract current mutation score
        id: score_current
        shell: bash
        run: |
          set -euo pipefail
          SUMMARY=$(find "${{ env.MODULE }}/target/pit-reports" -name "summary.xml" 2>/dev/null | head -n 1 || true)

          if [[ -n "${SUMMARY}" ]]; then
            CUR=$(grep -oPm1 '(?<=<mutationScore>)[0-9\.]+' "$SUMMARY" || true)
            if [[ -z "${CUR}" ]]; then
              CUR=$(grep -oPm1 '(?<=<score>)[0-9\.]+' "$SUMMARY" || true)
            fi
          fi

          if [[ -z "${CUR:-}" ]]; then
            LOG="${{ env.MODULE }}/pit.log"
            CUR=$(grep -oE 'Killed [0-9]+ \([0-9]+%' "$LOG" | grep -oE '[0-9]+%' | tr -d '%' | tail -n1)
          fi

          if [[ -z "${CUR:-}" ]]; then
            echo "Score introuvable" >&2
            exit 1
          fi

          echo "current=${CUR}" >> "$GITHUB_OUTPUT"
          echo "Score de mutation : ${CUR}%"

      - name: Read previous mutation score
        id: score_prev
        shell: bash
        run: |
          PREV="0"
          if [[ -f "${{ env.PIT_SCORE_FILE }}" ]]; then
            PREV=$(cat "${{ env.PIT_SCORE_FILE }}" | tr -d '\r\n' || echo "0")
          fi
          echo "prev=${PREV}" >> "$GITHUB_OUTPUT"

      - name: Fail if mutation score decreased
        shell: bash
        run: |
          CUR="${{ steps.score_current.outputs.current }}"
          PREV="${{ steps.score_prev.outputs.prev }}"
          cmp=$(awk -v a="$CUR" -v b="$PREV" 'BEGIN { if (a < b) print "lt"; else print "ge" }')
          if [[ "$cmp" == "lt" ]]; then
            echo "::error::Le score de mutation a diminuÃ© (${CUR}% < ${PREV}%)."
            exit 1
          fi
          echo "OK : score stable ou en hausse."

      - name: Rickroll on failure
        if: failure()
        run: |
          echo "Never gonna give you up"
          echo "Never gonna let you down"
          echo "Rickroll : https://www.youtube.com/watch?v=dQw4w9WgXcQ"

      - name: Store current score
        if: always()
        shell: bash
        run: |
          mkdir -p "${{ env.PIT_CACHE_DIR }}"
          echo "${{ steps.score_current.outputs.current }}" > "${{ env.PIT_SCORE_FILE }}"

      - name: Save updated score cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.PIT_CACHE_DIR }}
          key: ${{ env.PIT_CACHE_PREFIX }}${{ github.run_id }}
